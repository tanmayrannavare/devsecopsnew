pipeline {
    agent any

    tools {
        nodejs 'NodeJS-18'
    }

    environment {
        DOCKER_IMAGE = "tanmayrannavare/devsecops"
        DOCKER_TAG = "${BUILD_NUMBER}"
        SONARQUBE_SERVER = "SonarQube"
    }

    stages {

        stage('1. Git Checkout') {
            steps {
                echo 'üì¶ Cloning repository...'
                git branch: 'main',
                    url: 'https://github.com/tanmayrannavare/devsecopsnew.git'
            }
        }

        stage('2. SonarQube Analysis') {
            steps {
                echo 'üîç Running SonarQube scan...'
                script {
                    def scannerHome = tool 'SonarScanner'
                    withSonarQubeEnv("${SONARQUBE_SERVER}") {
                        sh """
                            ${scannerHome}/bin/sonar-scanner \
                            -Dsonar.projectKey=devsecops-web \
                            -Dsonar.projectName="DevSecOps Web App" \
                            -Dsonar.sources=. \
                            -Dsonar.exclusions=node_modules/**,build/**,dist/**,zap-report.html,trivy-report.json,.scannerwork/** \
                            -Dsonar.sourceEncoding=UTF-8
                        """
                    }
                }
            }
        }

        stage('3. Quality Gate Check') {
            steps {
                echo '‚è≥ Checking SonarQube Quality Gate...'
                timeout(time: 5, unit: 'MINUTES') {
                    waitForQualityGate abortPipeline: true
                }
            }
        }

        stage('4. Security Scan - Dependencies & Secrets') {
            steps {
                echo 'üß© Scanning for Node.js vulnerabilities and secrets...'
                sh '''
                    if [ -f "package.json" ]; then
                        npm audit || true
                    fi
                    echo "üîê Checking for secrets..."
                    grep -r "password\\|api_key\\|secret\\|token" . \
                        --include="*.js" --include="*.html" --include="*.css" || echo "‚úì No obvious secrets found"
                '''
            }
        }

        stage('5. Build Docker Image') {
            steps {
                echo 'üê≥ Building Docker image...'
                script {
                    def dockerImage = docker.build("${DOCKER_IMAGE}:${DOCKER_TAG}")
                    docker.build("${DOCKER_IMAGE}:latest")
                }
            }
        }

        stage('6. Scan Docker Image with Trivy') {
            steps {
                echo 'üîé Scanning Docker image for vulnerabilities...'
                sh '''
                    trivy image --format json --output trivy-report.json ${DOCKER_IMAGE}:${DOCKER_TAG}
                    trivy image --format table ${DOCKER_IMAGE}:${DOCKER_TAG}
                    trivy image --exit-code 1 --severity CRITICAL,HIGH ${DOCKER_IMAGE}:${DOCKER_TAG} || echo "‚ö†Ô∏è High vulnerabilities detected"
                '''
            }
            post {
                always {
                    archiveArtifacts artifacts: 'trivy-report.json', allowEmptyArchive: true
                }
            }
        }

        stage('7. Push Docker Image (Optional)') {
            steps {
                echo 'üì§ Pushing Docker image to Docker Hub...'
                script {
                    try {
                        docker.withRegistry('https://registry.hub.docker.com', 'dockerhub-credentials') {
                            def dockerImage = docker.image("${DOCKER_IMAGE}:${DOCKER_TAG}")
                            dockerImage.push("${DOCKER_TAG}")
                            dockerImage.push("latest")
                        }
                        echo "‚úÖ Docker image pushed successfully"
                    } catch (Exception e) {
                        echo "‚ö†Ô∏è Push skipped. Image available locally: ${DOCKER_IMAGE}:${DOCKER_TAG}"
                    }
                }
            }
        }

        stage('8. Deploy to Live (Public)') {
            input {
                message "üöÄ All checks passed. Deploy to Live?"
                ok "Deploy Now"
            }
            steps {
                echo 'üñ•Ô∏è Deploying to live environment...'
                sh '''
                    docker stop live-app || true
                    docker rm live-app || true
                    docker run -d --name live-app -p 80:80 ${DOCKER_IMAGE}:${DOCKER_TAG}
                    sleep 5
                    PUBLIC_IP=$(curl -s ifconfig.me)
                    echo "üåç Public IP: $PUBLIC_IP"
                    echo "‚úÖ App deployed successfully at: http://$PUBLIC_IP"
                '''
            }
        }

        stage('9. Dynamic Security Test - OWASP ZAP') {
            steps {
                echo 'üß† Running OWASP ZAP scan...'
                sh '''
                    sleep 5
                    docker pull ghcr.io/zaproxy/zaproxy:stable

                    docker run --user root --rm --network="host" \
                        -v $(pwd):/zap/wrk:rw \
                        -t ghcr.io/zaproxy/zaproxy:stable \
                        zap-baseline.py -t http://localhost -r zap-report.html || echo "‚ö†Ô∏è ZAP scan completed with findings"

                    echo "‚úÖ ZAP scan finished and report generated."
                '''
            }
            post {
                always {
                    publishHTML(target: [
                        allowMissing: true,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: '.',
                        reportFiles: 'zap-report.html',
                        reportName: 'ZAP Security Report'
                    ])
                }
            }
        }
    }

    post {
        always {
            echo 'üßπ Cleaning up build environment (keeping live app)...'
        }
        success {
            echo '‚úÖ Pipeline succeeded! Live app remains running.'
        }
        failure {
            echo '‚ùå Pipeline failed! Cleaning up live container...'
            sh '''
                docker stop live-app || true
                docker rm live-app || true
            '''
        }
    }
}
