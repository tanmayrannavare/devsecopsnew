pipeline {
    agent any

    tools {
        nodejs 'NodeJS-18' // NodeJS tool for SonarQube scanner
    }

    environment {
        DOCKER_IMAGE = "tanmayrannavare/devsecops"
        DOCKER_TAG = "${BUILD_NUMBER}"
        SONARQUBE_SERVER = "SonarQube"
    }

    stages {

        stage('1. Git Checkout') {
            steps {
                echo 'Cloning repository...'
                git branch: 'main',
                    url: 'https://github.com/tanmayrannavare/devsecopsnew.git'
            }
        }

        stage('2. SonarQube Analysis') {
            steps {
                echo 'Running SonarQube scan...'
                script {
                    def scannerHome = tool 'SonarScanner'
                    withSonarQubeEnv("${SONARQUBE_SERVER}") {
                        sh """
                            ${scannerHome}/bin/sonar-scanner \
                            -Dsonar.projectKey=devsecops-web \
                            -Dsonar.projectName="DevSecOps Web App" \
                            -Dsonar.sources=. \
                            -Dsonar.exclusions=node_modules/**,build/**,dist/** \
                            -Dsonar.sourceEncoding=UTF-8
                        """
                    }
                }
            }
        }

        stage('3. Quality Gate Check') {
            steps {
                echo 'Checking SonarQube Quality Gate...'
                timeout(time: 5, unit: 'MINUTES') {
                    waitForQualityGate abortPipeline: true
                }
            }
        }

        stage('4. Security Scan - Dependencies & Secrets') {
            steps {
                echo 'Scanning for Node.js vulnerabilities and secrets...'
                sh '''
                    if [ -f "package.json" ]; then
                        npm audit || true
                    fi
                    grep -r "password|api_key|secret|token" . \
                        --include="*.js" --include="*.html" --include="*.css" || echo "✓ No obvious secrets found"
                '''
            }
        }

        stage('5. Build Docker Image') {
            steps {
                echo 'Building Docker image...'
                script {
                    dockerImage = docker.build("${DOCKER_IMAGE}:${DOCKER_TAG}")
                    docker.build("${DOCKER_IMAGE}:latest")
                }
            }
        }

        stage('6. Scan Docker Image with Trivy') {
            steps {
                echo 'Scanning Docker image for vulnerabilities...'
                sh '''
                    trivy image --format json --output trivy-report.json ${DOCKER_IMAGE}:${DOCKER_TAG}
                    trivy image --format table ${DOCKER_IMAGE}:${DOCKER_TAG}
                    trivy image --exit-code 1 --severity CRITICAL,HIGH ${DOCKER_IMAGE}:${DOCKER_TAG} || echo "⚠️ High vulnerabilities detected"
                '''
            }
            post {
                always {
                    archiveArtifacts artifacts: 'trivy-report.json', allowEmptyArchive: true
                }
            }
        }

        stage('7. Push Docker Image (Optional)') {
            when {
                branch 'main'
            }
            steps {
                echo 'Pushing Docker image to Docker Hub...'
                script {
                    try {
                        docker.withRegistry('https://registry.hub.docker.com', 'dockerhub-credentials') {
                            dockerImage.push("${DOCKER_TAG}")
                            dockerImage.push("latest")
                        }
                        echo "Docker image pushed successfully"
                    } catch (Exception e) {
                        echo "⚠️ Push skipped. Image is available locally: ${DOCKER_IMAGE}:${DOCKER_TAG}"
                    }
                }
            }
        }

        stage('8. Deploy to Live') {
            when {
                branch 'main'
            }
            input {
                message "All checks passed. Deploy to Live?"
                ok "Deploy"
            }
            steps {
                echo 'Deploying to live environment...'
                sh '''
                    docker stop live-app || true
                    docker rm live-app || true
                    docker run -d --name live-app -p 80:80 ${DOCKER_IMAGE}:${DOCKER_TAG}
                    sleep 5
                    echo "✅ App deployed at http://$(hostname -I | awk '{print $1}')"
                '''
            }
        }

        stage('9. Dynamic Security Test - OWASP ZAP') {
            steps {
                echo 'Running OWASP ZAP scan...'
                sh '''
                    sleep 5
                    docker run --rm --network="host" -v $(pwd):/zap/wrk:rw \
                        -t owasp/zap2docker-stable \
                        zap-baseline.py -t http://localhost \
                        -r zap-report.html || echo "⚠️ ZAP scan completed with findings"
                '''
            }
            post {
                always {
                    publishHTML(target: [
                        allowMissing: true,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: '.',
                        reportFiles: 'zap-report.html',
                        reportName: 'ZAP Security Report'
                    ])
                }
            }
        }

    }

    post {
        always {
            echo 'Pipeline completed. Cleaning up temporary containers...'
            sh '''
                docker stop live-app || true
                docker rm live-app || true
            '''
        }
        success {
            echo '✅ Pipeline succeeded!'
        }
        failure {
            echo '❌ Pipeline failed!'
        }
    }
}

