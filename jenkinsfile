// FINAL, FULL Jenkinsfile - DevSecOps Web Application

pipeline {
    agent any

    tools {
        nodejs 'NodeJS-18' // Node.js for SonarQube JS scanning
    }

    environment {
        DOCKER_IMAGE = "tanmayrannavare/devsecops"
        DOCKER_TAG = "${BUILD_NUMBER}"
        SONARQUBE_SERVER = "SonarQube"
    }

    stages {
        stage('1. Git Checkout') {
            steps {
                echo 'Cloning Git repository...'
                git branch: 'main', url: 'https://github.com/tanmayrannavare/devsecopsnew.git'
            }
        }

        stage('2. Code Quality - SonarQube') {
            steps {
                echo 'Running SonarQube Analysis...'
                script {
                    def scannerHome = tool 'SonarScanner'
                    withSonarQubeEnv("${SONARQUBE_SERVER}") {
                        sh """
                            ${scannerHome}/bin/sonar-scanner \
                            -Dsonar.projectKey=devsecops-web \
                            -Dsonar.projectName="DevSecOps Web App" \
                            -Dsonar.sources=. \
                            -Dsonar.exclusions=node_modules/**,build/**,dist/** \
                            -Dsonar.sourceEncoding=UTF-8
                        """
                    }
                }
            }
        }

        stage('3. Quality Gate Check') {
            steps {
                echo 'Checking SonarQube Quality Gate...'
                timeout(time: 5, unit: 'MINUTES') {
                    waitForQualityGate abortPipeline: true
                }
            }
        }

        stage('4. Security Scan - Dependencies') {
            steps {
                echo 'Scanning Node.js dependencies for vulnerabilities...'
                sh '''
                    if [ -f "package.json" ]; then
                        npm audit || true
                    fi

                    echo "Scanning for hardcoded secrets..."
                    grep -r "password|api_key|secret|token" . \
                        --include="*.js" --include="*.html" --include="*.css" || echo "✓ No obvious secrets found"
                '''
            }
        }

        stage('5. Build Docker Image') {
            steps {
                echo 'Building Docker image...'
                script {
                    dockerImage = docker.build("${DOCKER_IMAGE}:${DOCKER_TAG}")
                    docker.build("${DOCKER_IMAGE}:latest")
                    echo "Docker image built: ${DOCKER_IMAGE}:${DOCKER_TAG}"
                }
            }
        }

        stage('6. Scan Docker Image - Trivy') {
            steps {
                echo 'Running Trivy Docker image scan...'
                sh '''
                    trivy image --format json --output trivy-report.json ${DOCKER_IMAGE}:${DOCKER_TAG}
                    trivy image --format table ${DOCKER_IMAGE}:${DOCKER_TAG}
                    trivy image --exit-code 1 --severity CRITICAL,HIGH ${DOCKER_IMAGE}:${DOCKER_TAG} || {
                        echo "⚠️ High severity vulnerabilities found"
                    }
                '''
            }
            post {
                always {
                    archiveArtifacts artifacts: 'trivy-report.json', allowEmptyArchive: true
                }
            }
        }

        stage('7. Push to Docker Registry (Optional)') {
            when { branch 'main' }
            steps {
                echo 'Pushing Docker image to registry...'
                script {
                    try {
                        docker.withRegistry('https://registry.hub.docker.com', 'dockerhub-credentials') {
                            dockerImage.push("${DOCKER_TAG}")
                            dockerImage.push("latest")
                        }
                    } catch (Exception e) {
                        echo "⚠️ Docker Hub push skipped. Image available locally: ${DOCKER_IMAGE}:${DOCKER_TAG}"
                    }
                }
            }
        }

        stage('8. Deploy to Test Environment') {
            steps {
                echo 'Deploying to Test environment...'
                sh '''
                    docker stop test-app || true
                    docker rm test-app || true
                    docker run -d --name test-app -p 80:80 ${DOCKER_IMAGE}:${DOCKER_TAG}
                    sleep 10
                    echo "✓ Test app deployed at: http://<SERVER-IP>:80"
                '''
            }
        }

        stage('9. Dynamic Security Test - OWASP ZAP') {
            steps {
                echo 'Running OWASP ZAP scan...'
                sh '''
                    sleep 5
                    docker run --rm --network="host" -v $(pwd):/zap/wrk:rw \
                        -t owasp/zap2docker-stable \
                        zap-baseline.py \
                        -t http://localhost:80 \
                        -r zap-report.html || echo "⚠️ ZAP scan completed with findings"
                '''
            }
            post {
                always {
                    publishHTML(target: [
                        allowMissing: true,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: '.',
                        reportFiles: 'zap-report.html',
                        reportName: 'ZAP Security Report'
                    ])
                }
            }
        }

        stage('10. Deploy to Live (Manual Approval)') {
            when { branch 'main' }
            input {
                message "All security checks passed. Deploy to Live?"
                ok "Deploy"
            }
            steps {
                echo 'Deploying to Live environment...'
                sh '''
                    docker stop live-app || true
                    docker rm live-app || true
                    docker run -d --name live-app -p 80:80 ${DOCKER_IMAGE}:${DOCKER_TAG}
                    sleep 10
                    echo "✅ Live app deployed at: http://<SERVER-IP>:80"
                '''
            }
        }
    }

    post {
        always {
            echo 'Pipeline completed.'
            sh '''
                docker stop test-app || true
                docker rm test-app || true
            '''
        }
        success { echo '✅ Pipeline succeeded!' }
        failure { echo '❌ Pipeline failed!' }
    }
}
